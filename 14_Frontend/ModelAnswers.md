# 模範解答

# ハンズオン手順

## 1. APIの向き先を変更
1. [config.js](config.js)を開く
2. baseURLの部分を、`http://<APIサーバのALBのDNS名>`に変更する

## 2.ECRリポジトリの作成
1. 「Elastic Container Registry」のダッシュボードを開く
2. `リポジトリを作成`をクリックします。 
3. レジストリ名に`front-repository`と入力し、それ以外の項目は変更不要として、`作成`をクリック    
4. 無事に`front-repository`が作成されていることを確認
5. `URI`の値をコピーしておく

## 2. IAMポリシーを作成
1. IAMのダッシュボードを開く
2. 左側のメニューから、「ポリシー」を選択
3. 右上の「ポリシーの作成」をクリック。
4. アクセス許可の指定部分で、「JSON」タブを選択
5. ポリシーエディターの部分に、下記のjsonを貼り付け（account-idは自分のIDに置き換え）
    
```json
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Action": [
                "ecr:GetAuthorizationToken"
            ],
            "Resource": "*"
        },
        {
            "Effect": "Allow",
            "Action": [
                "ecr:BatchCheckLayerAvailability",
                "ecr:InitiateLayerUpload",
                "ecr:UploadLayerPart",
                "ecr:CompleteLayerUpload",
                "ecr:PutImage"
            ],
            "Resource": "arn:aws:ecr:ap-northeast-1:<account-id>:repository/front-repository"
        }
    ]
}
```

6. 入力が完了したら、`次へ`をクリック
7. ポリシー名に`FrontEcrPushPolicy`を入力
8. それ以外はデフォルトのまま、`ポリシーの作成`をクリックし
7. 無事に`FrontEcrPushPolicy`が作成されていることを確認

## 3. IAMユーザを作成
1. 左側のメニューから`ユーザー`を選択
2. `ユーザーの作成`をクリックします。
3. ユーザー名として、`FrontEcrPushUser`と入力して、`次へ`をクリック
4. 許可のオプションでは、`ポリシーを直接アタッチする`を選択
5. 許可ポリシーからさきほど作成した`FrontEcrPushPolicy`を検索し、それをチェック
6. `次へ`をクリックします。 
7. 確認画面が表示されるので、問題がなければ`ユーザの作成`をクリック    
6. 無事に`FrontEcrPushUser`が作成されていることを確認

## 4. アクセスキーを作成
1. まずは、IAMユーザの一覧から`FrontEcrPushUser`を選択
2. 続いて、`セキュリティ認証情報`のタブを選択
3. `アクセスキーを作成`をクリック
4. ユースケースとして、`コマンドラインインターフェース`を選択
5. `上記のレコメンデーションを確認し、アクセスキーを作成します。`をチェックしたうえで、`次へ`をクリック
6. 説明タグは特は必要に応じて入力し、`アクセスキーを作成`をクリック
7. アクセスキーとシークレットアクセスキーが作成されるので、忘れずにメモしておくか、またはcsvファイルのダウンロードを行う
8. メモが完了したら、`終了`をクリック
   
# 5. アクセスキーの設定
1. `aws configure`コマンドを実行
2. アクセスキー、シークレットアクセスキーを入力

## 6. イメージの作成
下記コマンドを実行

```docker
docker image build --platform linux/x86_64 -t front-image . 
```

## 7. タグ付け
下記コマンドを実行（`your-ecr-uri`の部分はご自身のものに置き換え）

```docker
docker image tag front-image:latest <your-ecr-uri>:latest
```

## 8. ECRにログイン
下記コマンドを実行（`your-ecr-uri`の部分はご自身のものに置き換え）

```docker
aws ecr get-login-password --region ap-northeast-1 | docker login --username AWS --password-stdin <your-ecr-uri>
```

## 9. プッシュ
下記コマンドを実行（`your-ecr-uri`の部分はご自身のものに置き換え）

```docker
docker image push <your-ecr-uri>>y:latest
```

# 10. ECRリポジトリの確認
1. ECRリポジトリの一覧から`front-repository`を選択
2. latestタグが付いているイメージが存在することを確認








# ハンズオン手順
## 11. front-subnet-01を作成
1. 左側のメニューから、`サブネット`を選択
2. 右上の`サブネットを作成`をクリック
3. VPCとして、先ほど作成した`my-vpc`を選択
4. サブネットの設定を以下のように入力
    - サブネット名：`api-subnet-01`
    - アベイラビリティゾーン：`ap-northeast-1a`
    - IPv4サブネットCIDRブロック：`10.0.0.0/24`
5.  入力が完了したら、`サブネットを作成`をクリック
6. api-subnet-01が無事に作成されることを確認

## 3. インターネットゲートウェイ作成
1. 左側のメニューから`インターネットゲートウェイ`を開く
2. 右上の`インターネットゲートウェイの作成`をクリック
3. 名前タグに`my-internet-gateway`と入力
4. `インターネットゲートウェイの作成`をクリック
5. 無事にmy-internet-gatewayが作成されたら、`アクション` > `VPCにアタッチ`をクリック
6. 使用可能なVPCに、`my-vpc`を選択
7. `インターネットゲートウェイ`のアタッチをクリック

## 4. ルートテーブルを作成
1. 左側のメニューから、`ルートテーブル`を選択
2. 右上の`ルートテーブルの作成`をクリック
3. 名前に、api-routetableを入力
4. VPCに、my-vpcを選択
5. `ルートテーブルの作成`をクリック
6. `ルートを編集`をクリック
7. `ルートを追加`をクリック
8. 送信先に`0.0.0.0/0`、ターゲットに`my-internet-gateway`を入力し、`変更を保存`をクリック
9. 左側のメニューから、`サブネット`を選択します。
10. `api-subnet-01`のapi部分を選択します。
11. ルートテーブルのタブをクリックし、`ルートテーブルの関連付けを編集`をクリックします。
12. ルートテーブルIDを、`api-routetable`に変更します。
13. `保存`をクリックします

## 5. セキュリティグループの作成
1. 左側のメニューから、`セキュリティグループ`を選択
2. 右上の`セキュリティグループを作成`をクリック
3. セキュリティグループ名に`api-sg`、説明も`api-vpc`、VPCに`my-vpc`を選択
4. インバウンド`ルールを追加`をクリックし、タイプに`カスタムTCP`、ポート範囲に`8080`、ソースに`0.0.0.0/0`を選択
5. アウトバウンド`ルールの追加`をクリックし、タイプにすべてのトラフィック、送信先に`0.0.0.0/0`を入力します。
6. `セキュリティグループを作成`をクリックします。

## 6. タスク定義の設定
1. ECSのダッシュボードを開く
2. 左側のメニューから、`タスク定義`を選択
3. タスク定義ファミリーに`api-task`を入力
5. コンテナーの定義以下のように入力
    - 名前：`api-container`
    - イメージURI：api-image、latestのECRリポジトリのURI
    - コンテナポートは：`8080`とします
6. それ以外はデフォルトのまま`作成`ボタンをクリックします。

# 8. ECSサービスの作成
1. 先ほど作成した`MyCluster`をクリック
2. `作成`をクリック
3. `タスク定義のファミリー`に、`api-task`のタスク定義を選択。リビジョンは、`(最新)`とつくものを選択
4. ネットワーキングの部分を下記のように選択
    - ネットワーク：`my-vpc`
    - サブネット：`api-subnet-01`
    - セキュリティグループ：`api-sg`
5. `作成`をクリックします。
7. `api-task`が起動することを確認

# 9. 動作確認
1. `api-service`をクリック
2. `タスク`のタブを開く
3. 表示されるタスクのIDをクリック
4. パブリックIPアドレスを控える
5. ブラウザで新しいタブを開き、`http://<パブリックIPアドレス>:8080`を実行
6. `API接続テストが成功しました`というメッセージが表示されることを確認